%%
%% This is file `spellcards/aoe-chart.sty'
%%
%% Area of Effect reference chart for spellcards package
%% Provides lookup reference for AoE templates (burst, cone, line, etc.)
%%
%% Part of the spellcards package
%% Copyright (C) 2025 SoongJr
%% License: Open Source (see LICENSE file)
%%

\ProvidesExplFile{spellcards/aoe-chart.sty}{2025/11/01}{1.0.0}
{Area of Effect chart module for spellcards package}

%% ============================================================================
%% TikZ Grid Drawing Helper Functions
%% ============================================================================

\ExplSyntaxOff
% Document-level commands for use in TikZ diagrams
\newcommand{\AoEGrid}[2]{\draw[step=0.5cm,lightgray,very thin] (0,0) grid (#1*0.5,#2*0.5);}
\newcommand{\AoEOriginInt}[2]{\node[circle,draw=black,fill=white,inner sep=1pt] at (#1*0.5,#2*0.5) {\tiny O};}
\newcommand{\AoEOriginCaster}[2]{\fill[black] (#1*0.5,#2*0.5) circle (2pt);\node[above=2pt] at (#1*0.5,#2*0.5) {\tiny C};}
% Origin marker in square cell center (O in circle, matching burst style)
\newcommand{\AoEOriginSquare}[2]{\node[circle,draw=black,fill=white,inner sep=1pt] at (#1*0.5+0.25,#2*0.5+0.25) {\tiny O};}
% Shade affected square with darker, thicker border
\newcommand{\AoEShade}[2]{%
  \fill[black!20] (#1*0.5,#2*0.5) rectangle (#1*0.5+0.5,#2*0.5+0.5);%
  \draw[black!60,thick] (#1*0.5,#2*0.5) rectangle (#1*0.5+0.5,#2*0.5+0.5);%
}
\ExplSyntaxOn

%% ============================================================================
%% Specific AoE Diagram Commands
%% ============================================================================

%%% 5-foot radius burst (2x2 grid, origin at center intersection)
\NewDocumentCommand{\AoERadiusFiveFt}{}{%
  \begin{tikzpicture}[scale=1.2]
    % Draw grid first (so it's underneath)
    \AoEGrid{2}{2}
    % Shade affected squares
    \AoEShade{0}{0}
    \AoEShade{1}{0}
    \AoEShade{0}{1}
    \AoEShade{1}{1}
    % Origin at center intersection
    \AoEOriginInt{1}{1}
  \end{tikzpicture}%
}

\ExplSyntaxOff
%%% 10-foot radius burst (4x4 grid, origin at center intersection)
\NewDocumentCommand{\AoERadiusTenFt}{}{%
  \begin{tikzpicture}[scale=1.2]
    % Draw grid first (so it's underneath)
    \AoEGrid{4}{4}
    % Shade affected squares - diamond pattern
    \foreach \x/\y in {1/0, 2/0, 0/1, 1/1, 2/1, 3/1, 0/2, 1/2, 2/2, 3/2, 1/3, 2/3} {
        \AoEShade{\x}{\y}
      }
    % Origin at center
    \AoEOriginInt{2}{2}
  \end{tikzpicture}%
}

%%% 20-foot radius burst (8x8 grid, origin at center)
\NewDocumentCommand{\AoERadiusTwentyFt}{}{%
  \begin{tikzpicture}[scale=1.0]
    % Draw grid first (so it's underneath)
    \AoEGrid{8}{8}
    % Shade affected squares - larger diamond pattern
    \foreach \x/\y in {
        2/0, 3/0, 4/0, 5/0,
        1/1, 2/1, 3/1, 4/1, 5/1, 6/1,
        0/2, 1/2, 2/2, 3/2, 4/2, 5/2, 6/2, 7/2,
        0/3, 1/3, 2/3, 3/3, 4/3, 5/3, 6/3, 7/3,
        0/4, 1/4, 2/4, 3/4, 4/4, 5/4, 6/4, 7/4,
        0/5, 1/5, 2/5, 3/5, 4/5, 5/5, 6/5, 7/5,
        1/6, 2/6, 3/6, 4/6, 5/6, 6/6,
        2/7, 3/7, 4/7, 5/7
      } {
        \AoEShade{\x}{\y}
      }
    % Origin at center intersection
    \AoEOriginInt{4}{4}
  \end{tikzpicture}%
}

%%% 15-foot cone (north) - 3x4 grid, origin at (1,0)
\NewDocumentCommand{\AoEConeFifteenFtNorth}{}{%
  \begin{tikzpicture}[scale=1.2]
    % Draw grid first (so it's underneath)
    \AoEGrid{3}{4}
    % Shade affected squares - pattern: XXX/XXX/.X./.O.
    \foreach \x/\y in {0/3, 1/3, 2/3, 0/2, 1/2, 2/2, 1/1} {
        \AoEShade{\x}{\y}
      }
    % Origin at (1,0)
    \AoEOriginSquare{1}{0}
  \end{tikzpicture}%
}

%%% 15-foot cone pointing diagonal NE
\NewDocumentCommand{\AoEConeFifteenFtDiagonal}{}{%
  \begin{tikzpicture}[scale=1.2]
    % Draw grid first (so it's underneath)
    \AoEGrid{4}{4}
    % Shade affected squares - cone pattern matching ASCII: .X/.XX/.XXX/O...
    % Reading top-to-bottom: narrow at top (y=3), expanding toward origin at bottom (y=0)
    \foreach \x/\y in {1/3, 1/2, 2/2, 1/1, 2/1, 3/1} {
        \AoEShade{\x}{\y}
      }
    % Origin at caster position
    \AoEOriginSquare{0}{0}
  \end{tikzpicture}%
}

%%% 30-foot cone pointing north
\NewDocumentCommand{\AoEConeThirtyFtNorth}{}{%
  \begin{tikzpicture}[scale=1.0]
    % Draw grid first (so it's underneath)
    \AoEGrid{10}{8}
    % Shade affected squares - cone pattern matching ASCII (origin off-center)
    \foreach \x/\y in {4/1, 5/1,
        3/2, 4/2, 5/2, 6/2,
        2/3, 3/3, 4/3, 5/3, 6/3, 7/3,
        1/4, 2/4, 3/4, 4/4, 5/4, 6/4, 7/4, 8/4,
        0/5, 1/5, 2/5, 3/5, 4/5, 5/5, 6/5, 7/5, 8/5, 9/5,
        1/6, 2/6, 3/6, 4/6, 5/6, 6/6, 7/6, 8/6,
        2/7, 3/7, 4/7, 5/7, 6/7, 7/7} {
        \AoEShade{\x}{\y}
      }
    % Origin at caster position (off-center)
    \AoEOriginSquare{4}{0}
  \end{tikzpicture}%
}

%%% 30-foot cone pointing diagonal NE
\NewDocumentCommand{\AoEConeThirtyFtDiagonal}{}{%
  \begin{tikzpicture}[scale=1.0]
    % Draw grid first (so it's underneath)
    \AoEGrid{7}{7}
    % Shade affected squares - cone pattern (wide at top y=6, narrow near origin y=1)
    \foreach \x/\y in {1/1,
        1/2, 2/2, 3/2,
        1/3, 2/3, 3/3, 4/3,
        1/4, 2/4, 3/4, 4/4, 5/4,
        1/5, 2/5, 3/5, 4/5, 5/5,
        1/6, 2/6, 3/6, 4/6, 5/6, 6/6} {
        \AoEShade{\x}{\y}
      }
    % Origin at caster position
    \AoEOriginSquare{0}{0}
  \end{tikzpicture}%
}

%%% Consolidated 30-foot lines showing all 4 directions
\NewDocumentCommand{\AoELinesConsolidated}{}{%
  \begin{tikzpicture}[scale=1.2]
    % North line
    \begin{scope}[xshift=0cm]
      \AoEGrid{1}{7}
      \foreach \y in {1,2,3,4,5,6} {
          \AoEShade{0}{\y}
        }
      \AoEOriginSquare{0}{0}
    \end{scope}

    % NNE line
    \begin{scope}[xshift=1cm]
      \AoEGrid{2}{7}
      \foreach \x/\y in {0/1, 0/2, 0/3, 1/4, 1/5, 1/6} {
          \AoEShade{\x}{\y}
        }
      \AoEOriginSquare{0}{0}
    \end{scope}

    % NEE line
    \begin{scope}[xshift=2.5cm]
      \AoEGrid{3}{6}
      \foreach \x/\y in {0/1, 0/2, 1/2, 1/3, 1/4, 2/4, 2/5} {
          \AoEShade{\x}{\y}
        }
      \AoEOriginSquare{0}{0}
    \end{scope}

    % NE line
    \begin{scope}[xshift=4.5cm]
      \AoEGrid{5}{5}
      \foreach \i in {1,2,3,4} {
          \AoEShade{\i}{\i}
        }
      \AoEOriginSquare{0}{0}
    \end{scope}
  \end{tikzpicture}%
}
\ExplSyntaxOn


%% ============================================================================
%% Area of Effect Chart Command
%% ============================================================================

%%% Main command to render the AoE reference chart
%%% #1 = primary URL (optional, for QR code on left)
%%% #2 = secondary URL (optional, for QR code on right)
%%% Usage: \AreaOfEffectChart
%%%        \AreaOfEffectChart[url1]
%%%        \AreaOfEffectChart[url1][url2]
\NewDocumentCommand{\AreaOfEffectChart}{O{} O{}}{
  \group_begin:

  % Reset QR code counter for this page
  \spellcard_reset_qr_counter:

  %% Front side (page 1)
  \begin{center}{\Huge\bfseries Area~of~Effect}\end{center}
  \vspace{0.5em}

  % Row 1: Three diagrams (5ft radius, 10ft radius, 15ft cones with proper width allocation)
  \noindent\hfill
  \begin{minipage}[t]{3cm}
    \centering
    \AoERadiusFiveFt\\[0.3em]
    {\small 5-foot~radius}
  \end{minipage}\hfill
  \begin{minipage}[t]{3cm}
    \centering
    \AoERadiusTenFt\\[0.3em]
    {\small 10-foot~radius}
  \end{minipage}\hfill
  \begin{minipage}[t]{6cm}
    \centering
    \hfill\AoEConeFifteenFtNorth\hfill\AoEConeFifteenFtDiagonal\\[0.3em]
    {\small 15-foot~cones}
  \end{minipage}
  \hfill\\[1.5em]

  % Row 2: 20-foot radius and 30-foot cones (all at scale 1.0 to fit)
  \noindent\hfill
  \begin{minipage}[t]{6cm}
    \centering
    \AoERadiusTwentyFt\\[0.3em]
    {\small 20-foot~radius}
  \end{minipage}\hfill
  \begin{minipage}[t]{10.5cm}
    \centering
    \hfill\AoEConeThirtyFtNorth\hfill\AoEConeThirtyFtDiagonal\\[0.3em]
    \hspace{5.5em}{\small 30-foot~cones}
  \end{minipage}
  \hfill\\[1em]

  % Row 3: Consolidated line diagrams
  \noindent
  \begin{center}
    \AoELinesConsolidated\\[0.3em]
    {\small 30-foot~lines}
  \end{center}
  \vspace{2em}


  % Burst/Emanation/Spread explanations
  \noindent\textbf{Burst:}~Affects~whatever~it~catches~in~its~area.~%
  Cannot~extend~around~corners~(blocked~by~total~cover).\par
  \vspace{0.3em}

  \noindent\textbf{Emanation:}~Like~burst,~but~continues~to~radiate~%
  from~origin~for~spell~duration.\par
  \vspace{0.3em}

  \noindent\textbf{Spread:}~Like~burst,~but~CAN~extend~around~corners.\par

  % QR codes at bottom using proper spell card positioning
  \tl_if_empty:nF { #1 } { \SpellCardQR{#1} }
  \tl_if_empty:nF { #2 } { \SpellCardQR{#2} }

  \group_end:
}
