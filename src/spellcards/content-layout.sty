%%
%% This is file `spellcards/content-layout.sty'
%%
%% Content layout and orchestration for spellcards package
%% Provides the main spellcard environment and spell inclusion commands
%%
%% Part of the spellcards package
%% Copyright (C) 2025 SoongJr
%% License: Open Source (see LICENSE file)
%%

\ProvidesExplFile{spellcards/content-layout.sty}{2025/10/30}{1.0.0}
{Content layout module for spellcards package}

%% ============================================================================
%% Print Control System
%% ============================================================================

%%% Keys for spell inclusion options
\keys_define:nn { spellcard / includespell }
{
  % Whether to print the spell card (default: true)
  print .bool_set:N = \l_spellcard_include_print_bool,
  print .initial:n = true,
  print .default:n = true,

  % Alias: noprint sets print to false
  noprint .bool_set_inverse:N = \l_spellcard_include_print_bool,
  noprint .default:n = true,
}

%%% Internal function to include a spell file with options
%%% #1 = file path (relative to document root)
\cs_new:Nn \spellcard_include_spell:n
{
  % Save current print state
  \bool_set_eq:NN \l_tmpa_bool \g_spellcard_print_card_bool

  % Apply the print option (already set by keys_set in the caller)
  \bool_gset_eq:NN \g_spellcard_print_card_bool \l_spellcard_include_print_bool

  % Check if file exists before including
  \file_if_exist:nTF { #1 }
  {
    \file_input:n { #1 }
  }
  {
    \msg_error:nnn { spellcard } { spell-file-not-found } { #1 }
  }

  % Restore previous print state
  \bool_gset_eq:NN \g_spellcard_print_card_bool \l_tmpa_bool
}

%% ============================================================================
%% Spell Card Environment
%% ============================================================================

%%% Spell card environment
%%% Usage: \begin{spellcard}{class}{name}{level} ... \end{spellcard}
%%% This environment renders a complete spell card from property list data
%%% #1 = spell class (e.g., "sor", "wiz")
%%% #2 = spell name (e.g., "Magic Missile")
%%% #3 = spell level (0-9)
%%% #4 = spell body (captured by +b argument)
\NewDocumentEnvironment{SpellCard}{mmm+b}
{
  % Clear property list for this spell
  \prop_clear:N \l_spellcard_spell_props

  % Store basic spell metadata
  \tl_set:Nn \l_spellcard_class_tl { #1 }
  \tl_set:Nn \l_spellcard_name_tl { #2 }
  \int_set:Nn \l_spellcard_spell_level_int { #3 }

  % render only if card is to be printed:
  \bool_if:NT \g_spellcard_print_card_bool
  {
    % Reset counters
    \setcounter{page}{1}
    \setcounter{table}{0}
    \setcounter{figure}{0}
    \spellcard_reset_qr_counter:

    % Print title bar
    \section*{\Huge #2 \hfill \MakeUppercase{#1}~#3}

    % Render markers for level and deck name
    \spellcard_draw_spell_marker:n { #3 }
    \spellcard_draw_deck_label:nn
    { \int_use:N \g_spellcard_deck_number_int }
    { \tl_use:N \l_spellcard_current_deck_name_tl }

    % The body captured by +b:
    \vspace{.5ex}\raggedright\Large#4
  }
}
{
  % Register spell in current deck (if inside a deck)
  % Registration happens regardless of print state so deck indices are accurate
  % Expand both the name token list AND the level integer before passing to register
  \exp_args:NVV \spellcard_register_spell:nn \l_spellcard_name_tl \l_spellcard_spell_level_int

  % End of spell card
  \bool_if:NT \g_spellcard_print_card_bool
  {
    % if there was no back face to this card, make it empty and skip to next front face:
    \cleardoublepage
    % Reset counters
    \setcounter{page}{1}
    \setcounter{table}{0}
    \setcounter{figure}{0}
    \spellcard_reset_qr_counter:
  }
}

%% ============================================================================
%% User Commands
%% ============================================================================

%%% Spell Inclusion Command
%%% Usage: 
%%%   \IncludeSpell{spells/sor/1/MagicMissile}           % print the spell
%%%   \IncludeSpell[noprint]{spells/sor/1/MagicMissile}  % include without printing
%%%   \IncludeSpell[print=false]{spells/sor/1/MagicMissile}  % same as noprint
\NewDocumentCommand{\IncludeSpell}{O{} m}
{
  % Reset print option to default (true) before processing keys
  \bool_set_true:N \l_spellcard_include_print_bool

  % Process options (may override the default)
  \keys_set:nn { spellcard / includespell } { #1 }

  % Include the spell file
  \spellcard_include_spell:n { #2 }
}

%%% Legacy \noprint command for backwards compatibility
%%% New code should use \IncludeSpell[noprint]{...} instead
\NewDocumentCommand{\noprint}{m}
{
  % Save current print state
  \bool_set_eq:NN \l_tmpa_bool \g_spellcard_print_card_bool

  % Temporarily disable printing
  \bool_gset_false:N \g_spellcard_print_card_bool

  % Execute the code (typically \input{spellfile})
  #1

  % Restore previous print state
  \bool_gset_eq:NN \g_spellcard_print_card_bool \l_tmpa_bool
}

%% ============================================================================
%% Deck Index Card
%% ============================================================================

%%% Generate an index card for a deck showing spell counts by level
%%% #1 = deck number
%%% Creates a card with deck name and table of spell counts per level
\NewDocumentCommand{\DeckIndexCard}{m}
{
  \group_begin:
  % Only generate if deck exists
  \spellcard_if_deck_exists:nTF { #1 }
  {
    \spellcard_generate_deck_index_card:n { #1 }
  }
  {
    \msg_warning:nnn { spellcard } { deck-not-found } { #1 }
  }
  \group_end:
}

%%% Internal function to generate the deck index card
%%% #1 = deck number
\cs_new:Nn \spellcard_generate_deck_index_card:n
{
  % Suppress deck labels during index card generation
  \bool_gset_true:N \g_spellcard_suppress_deck_label_bool

  % Suppress page numbers for the entire index card (including overflow pages)
  % as it is only expected to have a front and a back face.
  \pagestyle{empty}

  % Deck name as section title ("Known Spells" for unnamed deck)
  % Check if deck has a name using tl_if_empty test
  \tl_set:Nx \l_tmpa_tl { \spellcard_get_deck_name:n { #1 } }
  \tl_if_empty:NTF \l_tmpa_tl
  {
    % Unnamed deck - use default title
    \section*{\Huge Known~Spells}
  }
  {
    % Named deck - use custom title
    \section*{\Huge \tl_use:N \l_tmpa_tl }
  }

  % Print spell list grouped by level in two columns with smart split
  \noindent
  \spellcard_build_spell_list_two_columns:n { #1 }

  \vfill

  % Restore deck label drawing
  \bool_gset_false:N \g_spellcard_suppress_deck_label_bool

  % Restore page numbering and ensure index is output before next deck
  \pagestyle{plain}
  \cleardoublepage
}

%%% Build spell list with level headers (alternative layout)
%%% #1 = deck number
%%% Format: Level headers with spell lists below
\cs_new_protected:Npn \spellcard_build_spell_list_by_level:n #1
{
  % Copy level list to temp sequence and sort numerically
  \seq_clear:N \l_tmpa_seq
  \int_step_inline:nnnn {0} {1} {9}
  {
    \seq_if_exist:cT { g_spellcard_deck_ #1 _level_ ##1 _seq }
    {
      \seq_if_empty:cF { g_spellcard_deck_ #1 _level_ ##1 _seq }
      {
        \par\noindent\subsection*{Level~##1}
        % Typeset each spell name on its own line (####1 is the spell name from seq_map_inline)
        \seq_map_inline:cn { g_spellcard_deck_ #1 _level_ ##1 _seq } { ####1 \\ }
      }
    }
  }
}

%%% Build spell list in two columns with multicol (inline format with level prefixes)
%%% #1 = deck number
%%% Format: "X -- Spell Name" with alternating bold levels (excluding empty levels)
\cs_new_protected:Npn \spellcard_build_spell_list_two_columns:n #1
{
  % Use multicol for automatic balancing
  \begin{multicols}{2}
    \raggedright\Large

    % Track whether current level should be bold (alternates, skipping empty levels)
    \bool_set_true:N \l_tmpa_bool  % Start with bold for first populated level

    % Iterate over levels that exist in the deck
    \seq_map_inline:cn { g_spellcard_deck_ #1 _levels_seq }
    {
      \seq_if_exist:cT { g_spellcard_deck_ #1 _level_ ##1 _seq }
      {
        \seq_if_empty:cF { g_spellcard_deck_ #1 _level_ ##1 _seq }
        {
          % Store the level number for use in nested inline
          \tl_set:Nn \l_tmpb_tl { ##1 }

          % Render each spell with compact level prefix
          \seq_map_inline:cn { g_spellcard_deck_ #1 _level_ ##1 _seq }
          {
            \bool_if:NTF \l_tmpa_bool
            {
              % Bold level prefix (####1 is the spell name in nested map)
              \textbf{\tl_use:N \l_tmpb_tl~--} ~ ####1 \\
            }
            {
              % Normal level prefix
              \tl_use:N \l_tmpb_tl~--~ ####1 \\
            }
          }
          % Add some vertical space between levels
          \bigbreak

          % Toggle bold for next populated level
          \bool_set:Nn \l_tmpa_bool { ! \l_tmpa_bool }
        }% check name sequence not empty
      }% check name sequence exists
    }% iterate over levels
  \end{multicols}
}

%% ============================================================================
%% Initialization
%% ============================================================================

% Check for printer margins at package load
\AtBeginDocument
{
  \spellcard_check_printer_margins:
}

\endinput
%%
%% End of file `spellcards/content-layout.sty'.
%%
