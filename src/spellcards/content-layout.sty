%%
%% This is file `spellcards/content-layout.sty'
%%
%% Content layout and orchestration for spellcards package
%% Provides the main spellcard environment and spell inclusion commands
%%
%% Part of the spellcards package
%% Copyright (C) 2025 SoongJr
%% License: Open Source (see LICENSE file)
%%

\ProvidesExplFile{spellcards/content-layout.sty}{2025/10/30}{1.0.0}
{Content layout module for spellcards package}

%% ============================================================================
%% Print Control System
%% ============================================================================

%%% Keys for spell inclusion options
\keys_define:nn { spellcard / includespell }
{
  % Whether to print the spell card (default: true)
  print .bool_set:N = \l_spellcard_include_print_bool,
  print .initial:n = true,
  print .default:n = true,

  % Alias: noprint sets print to false
  noprint .bool_set_inverse:N = \l_spellcard_include_print_bool,
  noprint .default:n = true,
}

%%% Internal function to include a spell file with options
%%% #1 = file path (relative to document root)
\cs_new:Nn \spellcard_include_spell:n
{
  % Save current print state
  \bool_set_eq:NN \l_tmpa_bool \g_spellcard_print_card_bool

  % Apply the print option (already set by keys_set in the caller)
  \bool_gset_eq:NN \g_spellcard_print_card_bool \l_spellcard_include_print_bool

  % Check if file exists before including
  \file_if_exist:nTF { #1 }
  {
    \file_input:n { #1 }
  }
  {
    \msg_error:nnn { spellcard } { spell-file-not-found } { #1 }
  }

  % Restore previous print state
  \bool_gset_eq:NN \g_spellcard_print_card_bool \l_tmpa_bool
}

%% ============================================================================
%% Spell Card Environment
%% ============================================================================

%%% Helper function to end spell card (internal cleanup)
%%% Called at the end of spellcard environment
\cs_new_protected:Npn \spellcard_end_card:
{
  % End of spell card
  \bool_if:NT \g_spellcard_print_card_bool
  {
    \cleardoublepage  % Document class controls what this means (draft vs final)
  }

  % Reset counters
  \setcounter{page}{1}
  \setcounter{table}{0}
  \setcounter{figure}{0}
  \spellcard_reset_qr_counter:
}

%%% Spell card environment
%%% Usage: \begin{spellcard}{class}{name}{level} ... \end{spellcard}
%%% This environment renders a complete spell card from property list data
%%% #1 = spell class (e.g., "sor", "wiz")
%%% #2 = spell name (e.g., "Magic Missile")
%%% #3 = spell level (0-9)
%%% #4 = spell body (captured by +b argument)
\NewDocumentEnvironment{spellcard}{mmm+b}
{
  % Clear property list for this spell
  \prop_clear:N \l_spellcard_spell_props

  % Store basic spell metadata
  \tl_set:Nn \l_spellcard_class_tl { #1 }
  \tl_set:Nn \l_spellcard_name_tl { #2 }
  \int_set:Nn \l_spellcard_spell_level_int { #3 }

  % render only if card is to be printed:
  \bool_if:NT \g_spellcard_print_card_bool
  {
    % Print title bar
    \section*{\Huge #2 \hfill \MakeUppercase{#1}~#3}

    % Render markers for level and deck name
    \spellcard_draw_spell_marker:n { #3 }
    \spellcard_draw_deck_label:nn
    { \int_use:N \g_spellcard_deck_number_int }
    { \tl_use:N \l_spellcard_current_deck_name_tl }

    % The body captured by +b:
    \vspace{.5ex}\raggedright\Large#4
  }
}
{
  \spellcard_end_card:
}

%% ============================================================================
%% User Commands
%% ============================================================================

%%% Spell Inclusion Command
%%% Usage: 
%%%   \includespell{spells/sor/1/MagicMissile}           % print the spell
%%%   \includespell[noprint]{spells/sor/1/MagicMissile}  % include without printing
%%%   \includespell[print=false]{spells/sor/1/MagicMissile}  % same as noprint
\NewDocumentCommand{\includespell}{O{} m}
{
  % Reset print option to default (true) before processing keys
  \bool_set_true:N \l_spellcard_include_print_bool

  % Process options (may override the default)
  \keys_set:nn { spellcard / includespell } { #1 }

  % Include the spell file
  \spellcard_include_spell:n { #2 }
}

%%% Legacy \noprint command for backwards compatibility
%%% New code should use \includespell[noprint]{...} instead
\NewDocumentCommand{\noprint}{m}
{
  % Save current print state
  \bool_set_eq:NN \l_tmpa_bool \g_spellcard_print_card_bool

  % Temporarily disable printing
  \bool_gset_false:N \g_spellcard_print_card_bool

  % Execute the code (typically \input{spellfile})
  #1

  % Restore previous print state
  \bool_gset_eq:NN \g_spellcard_print_card_bool \l_tmpa_bool
}

%% ============================================================================
%% Initialization
%% ============================================================================

% Check for printer margins at package load
\AtBeginDocument
{
  \spellcard_check_printer_margins:
}

\endinput
%%
%% End of file `spellcards/content-layout.sty'.
%%
