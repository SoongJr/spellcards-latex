%%
%% This is file `spellcards/deck.sty'
%%
%% Deck management for spellcards package
%% Provides deck state tracking, spell registration, and deck label rendering
%%
%% Part of the spellcards package
%% Copyright (C) 2025 SoongJr
%% License: Open Source (see LICENSE file)
%%

\ProvidesExplFile{spellcards/deck.sty}{2025/10/30}{1.0.0}
{Deck management module for spellcards package}

%% ============================================================================
%% Variables
%% ============================================================================

%%% Boolean for environment-level deckindex option
\bool_new:N \l_spellcard_deckindex_env_bool
\bool_set_true:N \l_spellcard_deckindex_env_bool  % Default to true

%% ============================================================================
%% Deck State Management
%% ============================================================================

%%% Start a new spell deck
%%% #1 = deck name (empty for first deck, required for subsequent decks)
%%% Updates current deck state variables and initializes spell tracking
\cs_new:Nn \spellcard_deck_begin:n
{
% Check for nested decks (error if we're already in a deck)
\bool_if:NTF \g_spellcard_in_deck_bool
{
  \msg_error:nn { spellcard } { nested-decks }
}
{
  % Mark that we're now in a deck
  \bool_gset_true:N \g_spellcard_in_deck_bool
}

% Validate deck naming rules BEFORE setting the name
\int_compare:nNnTF { \g_spellcard_deck_number_int } = { 0 }
{
% First deck must be unnamed
\tl_if_empty:nF { #1 }
{
  \msg_error:nn { spellcard } { first-deck-must-be-unnamed }
}
}
{
% Subsequent decks must be named
\tl_if_empty:nT { #1 }
{
  \msg_error:nn { spellcard } { only-first-deck-unnamed }
}
}

% Set the new deck name (after validation)
\tl_set:Nn \l_spellcard_current_deck_name_tl { #1 }
}

%%% End a spell deck
%%% Increments deck counter, stores spell list, and clears current deck name
\cs_new:Nn \spellcard_deck_end:
{
  % Store deck name in a dedicated token list for easy retrieval
  \tl_new:c { g_spellcard_deck_ \int_use:N \g_spellcard_deck_number_int _name_tl }
  \tl_gset:cx { g_spellcard_deck_ \int_use:N \g_spellcard_deck_number_int _name_tl }
  { \tl_use:N \l_spellcard_current_deck_name_tl }

  % Store metadata about this deck in property list
  % Format: "deck_N" -> "name={...},count=N"
  % Compute total spell count by summing lengths of per-level sequences (if any)
  \int_zero_new:N \l_spellcard_deck_count_int
  \int_zero:N \l_spellcard_deck_count_int
  \int_step_inline:nnnn {0} {1} {9}
  {
    \seq_if_exist:cT { g_spellcard_deck_ \int_use:N \g_spellcard_deck_number_int _level_ ##1 _seq }
    { \int_add:Nn \l_spellcard_deck_count_int { \seq_count:c { g_spellcard_deck_ \int_use:N \g_spellcard_deck_number_int _level_ ##1 _seq } } }
  }
  % Store metadata token list (key and value identical for now)
  \tl_set:Nx \l_tmpa_spellcard_tl { name={\tl_use:N \l_spellcard_current_deck_name_tl},count={\int_use:N \l_spellcard_deck_count_int} }
  \prop_gput:NVn \g_spellcard_decks_prop \l_tmpa_spellcard_tl { \tl_use:N \l_tmpa_spellcard_tl }

  % Automatically generate index card for this deck (if enabled via class option AND environment option)
  \ifspellcard@deckindex
    \bool_if:NT \l_spellcard_deckindex_env_bool
    {
      \spellcard_deck_index_card:n { \int_use:N \g_spellcard_deck_number_int }
    }
  \fi

  % Increment the global deck counter
  \int_gincr:N \g_spellcard_deck_number_int

  % Clear the current deck name to mark we're outside a deck
  \tl_clear:N \l_spellcard_current_deck_name_tl

  % Mark that we're no longer in a deck
  \bool_gset_false:N \g_spellcard_in_deck_bool
}

%% ============================================================================
%% Spell Registration System
%% ============================================================================

%%% Internal: append a spell name to its level-specific sequence
%%% Per-deck level sequences: g_spellcard_deck_<deck>_level_<level>_seq
%%% Level list sequence:     g_spellcard_deck_<deck>_levels_seq (stores raw level ints)
\cs_new_protected:Npn \spellcard_add_spell_to_level:nnn #1#2#3
{
  % Ensure level list exists
  \seq_if_exist:cF { g_spellcard_deck_ #1 _levels_seq } { \seq_new:c { g_spellcard_deck_ #1 _levels_seq } }
  % Ensure per-level sequence exists
  \seq_if_exist:cF { g_spellcard_deck_ #1 _level_ #2 _seq } { \seq_new:c { g_spellcard_deck_ #1 _level_ #2 _seq } }
  % Record level if first time
  \seq_if_in:cnF { g_spellcard_deck_ #1 _levels_seq } { #2 } { \seq_gput_right:cn { g_spellcard_deck_ #1 _levels_seq } { #2 } }
  % Append spell name directly (fully expanded from caller)
  \seq_gput_right:cn { g_spellcard_deck_ #1 _level_ #2 _seq } { #3 }
}

%%% Register a spell in the current deck's spell list (flat sequence + level registry)
%%% #1 = spell name
%%% #2 = spell level
\cs_new_protected:Npn \spellcard_register_spell:nn #1#2
{
  % Only register if we're inside a deck (use deck boolean)
  \bool_if:NT \g_spellcard_in_deck_bool
  {
    % Update per-level sequences for current deck number
    \spellcard_add_spell_to_level:nnn { \int_use:N \g_spellcard_deck_number_int } { #2 } { #1 }
  }
}

%% ============================================================================
%% Deck Label Position Calculations
%% ============================================================================

%%% Calculate label position at top edge based on deck number
%%% #1 = deck number (1-6, then wraps; 0 has no label)
%%% Updates \l_spellcard_label_position_dim
%%% Formula: ((1/8 * mod(deck-1, 6)) * paperwidth) + offset
%%% Offset is 7mm with printer margins, 15mm without
\cs_new:Nn \spellcard_calculate_label_position:n
{
  % Calculate modulo 6 for deck wrapping (deck-1 because deck 0 has no label)
  \fp_set:Nn \l_tmpb_spellcard_fp { #1 - 1 }
  \fp_set:Nn \l_tmpa_spellcard_fp { \l_tmpb_spellcard_fp - 6 * floor(\l_tmpb_spellcard_fp / 6) }

  % Calculate base position: (1/8 * deck_mod) * paperwidth
  \fp_set:Nn \l_spellcard_label_position_fp
  {
    ( \c_spellcard_label_spacing_fp * \l_tmpa_spellcard_fp )
    * \dim_to_fp:n { \paperwidth }
  }

  % Add offset based on whether printer margins are defined
  \bool_if:NTF \l_spellcard_has_printer_margin_bool
  {
    % With printer margins: add 7mm offset
    \fp_add:Nn \l_spellcard_label_position_fp { 7mm }
  }
  {
    % Without printer margins: add 15mm offset
    \fp_add:Nn \l_spellcard_label_position_fp { 15mm }
  }

  % Convert to dimension for TikZ usage
  \dim_set:Nn \l_spellcard_label_position_dim
  { \fp_to_dim:N \l_spellcard_label_position_fp }
}

%%% Helper to get y-shift for deck label based on printer margins
\cs_new:Nn \spellcard_get_label_yshift:
{
  \bool_if:NTF \l_spellcard_has_printer_margin_bool
  { 7mm }
  { 15mm }
}

%% ============================================================================
%% Deck Label Rendering
%% ============================================================================

%%% Draw deck label at top edge of page
%%% #1 = deck number, #2 = deck name
%%% Deck 0 (unnamed deck) has no label
\cs_new_protected:Npn \spellcard_draw_deck_label:nn #1 #2
{
  % Skip drawing if suppressed (e.g., during deck index card generation)
  \bool_if:NF \g_spellcard_suppress_deck_label_bool
  {
    % Deck 0 (unnamed deck) has no label
    \int_compare:nNnF { #1 } = { 0 }
      {
        % Calculate label position
        \spellcard_calculate_label_position:n { #1 }

        \begin{tikzpicture}[remember~ picture,~ overlay]
          % Draw deck name at top edge
          \node [font=\normalsize\itshape, anchor=west,
            xshift=\fp_to_dim:N \l_spellcard_label_position_fp,
            yshift=-\spellcard_get_label_yshift:]
          at~ (current~ page.north~ west) {#2};
        \end{tikzpicture}
      }
  }
}

%% ============================================================================
%% Deck Query Functions
%% ============================================================================

%%% Get the number of spells in a specific deck (sum of per-level sequences)
%%% #1 = deck number
%%% Returns: integer count
\cs_new:Nn \spellcard_get_deck_spell_count:n
{
  \int_zero:N \l_tmpa_int
  \seq_if_exist:cT { g_spellcard_deck_ #1 _levels_seq }
  {
    \seq_map_inline:cn { g_spellcard_deck_ #1 _levels_seq }
    { \int_add:Nn \l_tmpa_int { \seq_count:c { g_spellcard_deck_ #1 _level_ ##1 _seq } } }
  }
  \int_use:N \l_tmpa_int
}

%%% Get the total number of decks created
\cs_new:Nn \spellcard_get_deck_count:
{
  \int_use:N \g_spellcard_deck_number_int
}

%%% Get a deck's name
%%% #1 = deck number
%%% Returns: deck name (empty string for deck 0)
\cs_new:Nn \spellcard_get_deck_name:n
{
  \tl_if_exist:cTF { g_spellcard_deck_ #1 _name_tl }
  {
    \tl_use:c { g_spellcard_deck_ #1 _name_tl }
  }
  {
    % Return empty if deck doesn't exist
  }
}

%%% Check if a deck exists
%%% #1 = deck number
\prg_new_conditional:Npnn \spellcard_if_deck_exists:n #1 { p, T, F, TF }
{
  \seq_if_exist:cTF { g_spellcard_deck_ #1 _levels_seq }
  { \prg_return_true: }
  { \prg_return_false: }
}

% Legacy spell mapping removed (flat sequence deprecated)

%%% Count spells of a specific level in a deck (direct per-level sequence length)
%%% #1 = deck number, #2 = level
\cs_new:Nn \spellcard_count_spells_by_level:nn
{
  \seq_count:c { g_spellcard_deck_ #1 _level_ #2 _seq }
}

% Legacy show deck utility removed (flat sequence deprecated)

%% ============================================================================
%% Deck Environment
%% ============================================================================

%%% Spell deck environment
%%% Usage: \begin{SpellDeck}[name] ... \end{SpellDeck}
%%%   or:  \begin{SpellDeck}{name} ... \end{SpellDeck}  (for cardify compatibility)
%%% First deck must have empty name, subsequent decks must be named
% Add deckindex option to SpellDeck environment
% Usage: \begin{SpellDeck}[deckindex=true]{name} ... \end{SpellDeck}
\keys_define:nn { spellcard/deck }
{
  deckindex .bool_set:N = \l_spellcard_deckindex_env_bool,
  deckindex .default:n = true,
}

\NewDocumentEnvironment{SpellDeck}{O{} G{}}
{
  \keys_set:nn { spellcard/deck } {#1} % Parse options (deckindex)
  \spellcard_deck_begin:n { #2 } % Use #2 as deck name
}
{
  \spellcard_deck_end:
}

%% ============================================================================
%% User Commands for Deck Management
%% ============================================================================

%%% Internal command: Register a spell manually in the current deck (future: deck index cards)
%%% Usage: \register_spell{spells/sor/1/MagicMissile.tex}{sor}{Magic Missile}{1}
\NewDocumentCommand{\register_spell}{m m m m}
{
  % Arguments: file, class, name, level. We only need name+level.
  \spellcard_register_spell:nn { #3 } { #4 }
}

%%% Internal command: Get count of spells in a deck (future: deck index cards)
%%% Usage: \deck_spell_count{0} → prints number
\NewDocumentCommand{\deck_spell_count}{m}
{
  \spellcard_get_deck_spell_count:n { #1 }
}

%%% Debug command: Count spells by level in a deck
%%% Usage: \deck_spell_count_by_level{0}{1} → prints number of level 1 spells in deck 0
\NewDocumentCommand{\deck_spell_count_by_level}{m m}
{
  \spellcard_count_spells_by_level:nn { #1 } { #2 }
}

%%% Internal command: Get total number of decks (future: deck index cards)
%%% Usage: \deck_count → prints number
\NewDocumentCommand{\deck_count}{}
{
  \spellcard_get_deck_count:
}

%%% Debug utility: Show deck information
%%% Usage: \ShowDeck{0}
\NewDocumentCommand{\ShowDeck}{m}
{
  \spellcard_show_deck:n { #1 }
}
