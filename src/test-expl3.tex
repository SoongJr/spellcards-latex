%%
%% Test document for spellcard-expl3.sty
%% Verifies that the package loads and basic variables are accessible
%%

\documentclass[
  a4paper,
  fontsize=12pt,
]{scrartcl}

\usepackage[utf8]{inputenc}

% Load the new expl3 package with printer margin options
\usepackage[printer-margin-x=7mm, printer-margin-y=7mm]{spellcard-expl3}

\begin{document}

\section*{expl3 Package Test Document}

This document tests that the \texttt{spellcard-expl3.sty} package loads correctly
and that all variables are properly initialized.

\ExplSyntaxOn{}

\subsection*{Boolean Variables}
\begin{itemize}
  \item Print~card~flag: \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE }
  \item In~deck~flag: \bool_if:NTF \g_spellcard_in_deck_bool { TRUE } { FALSE }
  \item Has~printer~margin: \bool_if:NTF \l_spellcard_has_printer_margin_bool { TRUE } { FALSE }
\end{itemize}

\subsection*{Integer Variables}
\begin{itemize}
  \item Deck~number: \int_use:N \g_spellcard_deck_number_int
  \item QR~code~count: \int_use:N \g_spellcard_qr_code_int
  \item Spell~level: \int_use:N \l_spellcard_spell_level_int
\end{itemize}

\subsection*{Constants}
\begin{itemize}
  \item Max~QR~codes~per~page: \int_use:N \c_spellcard_max_qr_codes_int
  \item Max~deck~columns: \int_use:N \c_spellcard_max_deck_columns_int
  \item NULL~value: ``\tl_use:N \c_spellcard_null_value_tl''
\end{itemize}

\subsection*{Test: NULL Detection}
Testing~the~\texttt{\token_to_str:N\spellcard_if_not_null:nTF}~predicate:
\begin{itemize}
  \item Value~``test'': \spellcard_if_not_null:nTF { test } { NOT~NULL } { IS~NULL }
  \item Value~``NULL'': \spellcard_if_not_null:nTF { NULL } { NOT~NULL } { IS~NULL }
  \item Empty~value: \spellcard_if_not_null:nTF { } { NOT~NULL } { IS~NULL }
\end{itemize}

\subsection*{Test: Token Lists}
\tl_set:Nn \l_spellcard_name_tl { Fireball }
\tl_set:Nn \l_spellcard_class_tl { sor }
\tl_set:Nn \l_spellcard_school_tl { evocation }

Spell~name: \tl_use:N \l_spellcard_name_tl \\
Class: \tl_use:N \l_spellcard_class_tl \\
School: \tl_use:N \l_spellcard_school_tl

\subsection*{Test: Property List}
\prop_put:Nnn \l_spellcard_spell_props { name } { Magic~Missile }
\prop_put:Nnn \l_spellcard_spell_props { level } { 1 }
\prop_put:Nnn \l_spellcard_spell_props { school } { evocation }

Reading~from~property~list:
\begin{itemize}
  \item Name: \prop_item:Nn \l_spellcard_spell_props { name }
  \item Level: \prop_item:Nn \l_spellcard_spell_props { level }
  \item School: \prop_item:Nn \l_spellcard_spell_props { school }
\end{itemize}

\subsection*{Test: Integer Operations}
Initial~spell~level: \int_use:N \l_spellcard_spell_level_int \\
\int_set:Nn \l_spellcard_spell_level_int { 3 }
After~setting~to~3: \int_use:N \l_spellcard_spell_level_int \\
\int_incr:N \l_spellcard_spell_level_int
After~increment: \int_use:N \l_spellcard_spell_level_int

\subsection*{Test: Floating Point Calculations}
\fp_set:Nn \l_tmpa_spellcard_fp { 1/8 }
\fp_set:Nn \l_tmpb_spellcard_fp { 2.5 }
\fp_set:Nn \l_spellcard_marker_position_fp
{ \l_tmpa_spellcard_fp + \l_tmpb_spellcard_fp }

${1}/{8} + 2.5 = {}\fp_use:N \l_spellcard_marker_position_fp{}$

\subsection*{Test: String Comparison}
\str_if_eq:nnTF { NULL } { NULL }
{ String~``NULL''~equals~``NULL'': TRUE }
{ String~``NULL''~equals~``NULL'': FALSE } \\
\str_if_eq:nnTF { test } { NULL }
{ String~``test''~equals~``NULL'': TRUE }
{ String~``test''~equals~``NULL'': FALSE }

\ExplSyntaxOff{}

\subsection*{Phase 2: Deck Management Tests}

Testing the spell deck environment:

\begin{spelldeck}{}
  First deck (unnamed spellbook). \\
  Current deck number: \ExplSyntaxOn \int_use:N \g_spellcard_deck_number_int \ExplSyntaxOff \\
  Current deck name: ``\ExplSyntaxOn \tl_use:N \l_spellcard_current_deck_name_tl \ExplSyntaxOff''
\end{spelldeck}

After first deck: \\
Current deck number: \ExplSyntaxOn \int_use:N \g_spellcard_deck_number_int \ExplSyntaxOff

\begin{spelldeck}{Combat Spells}
  Second deck (named). \\
  Current deck number: \ExplSyntaxOn \int_use:N \g_spellcard_deck_number_int \ExplSyntaxOff \\
  Current deck name: ``\ExplSyntaxOn \tl_use:N \l_spellcard_current_deck_name_tl \ExplSyntaxOff''
\end{spelldeck}

After second deck: \\
Current deck number: \ExplSyntaxOn \int_use:N \g_spellcard_deck_number_int \ExplSyntaxOff

\begin{spelldeck}{Utility Spells}
  Third deck (also named). \\
  Current deck number: \ExplSyntaxOn \int_use:N \g_spellcard_deck_number_int \ExplSyntaxOff \\
  Current deck name: ``\ExplSyntaxOn \tl_use:N \l_spellcard_current_deck_name_tl \ExplSyntaxOff''
\end{spelldeck}

After third deck: \\
Current deck number: \ExplSyntaxOn \int_use:N \g_spellcard_deck_number_int \ExplSyntaxOff

\subsection*{Phase 2: Print Control Tests}

Testing the print control system with \texttt{\textbackslash{}includespell}:

\ExplSyntaxOn

Initial~print~flag: \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \\

% Test setting the flag
\bool_gset_false:N \g_spellcard_print_card_bool
After~setting~false: \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \\

\bool_gset_true:N \g_spellcard_print_card_bool
After~setting~true: \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \\

\ExplSyntaxOff

\subsubsection*{Test 1: Default behavior (print enabled)}

Print~flag~before:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\includespell{test-spell.tex}

Print~flag~after:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\subsubsection*{Test 2: Using [noprint] option}

Print~flag~before:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\includespell[noprint]{test-spell.tex}

Print~flag~after:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\subsubsection*{Test 3: Using [print=false] option}

Print~flag~before:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\includespell[print=false]{test-spell.tex}

Print~flag~after:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\subsubsection*{Test 4: Legacy {\textbackslash}noprint command}

Print~flag~before:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\noprint{\input{test-spell.tex}}

Print~flag~after:~\ExplSyntaxOn{} \bool_if:NTF \g_spellcard_print_card_bool { TRUE } { FALSE } \ExplSyntaxOff{}

\subsection*{Conclusion}

If this document compiles without errors, the \texttt{spellcard-expl3.sty} package
is working correctly and ready for Phase 2 implementation.

\newpage

\subsection*{Phase 2.2: Positioning Calculations Tests}

Testing the positioning calculation functions added in Phase 2.2.

\ExplSyntaxOn

\subsubsection*{Marker Position Calculations}

Testing~\texttt{\token_to_str:N\spellcard_calculate_marker_position:n}~for~spell~levels~0-9:

\begin{itemize}
  \item Level~0:
        \spellcard_calculate_marker_position:n { 0 }
        \dim_use:N \l_spellcard_marker_position_dim{}
        ~(expected:~2.5cm)

  \item Level~1:
        \spellcard_calculate_marker_position:n { 1 }
        \dim_use:N \l_spellcard_marker_position_dim{}

  \item Level~3:
        \spellcard_calculate_marker_position:n { 3 }
        \dim_use:N \l_spellcard_marker_position_dim{}

  \item Level~5:
        \spellcard_calculate_marker_position:n { 5 }
        \dim_use:N \l_spellcard_marker_position_dim{}

  \item Level~9:
        \spellcard_calculate_marker_position:n { 9 }
        \dim_use:N \l_spellcard_marker_position_dim{}
        ~(max~core~level)

  \item Level~10:
        \spellcard_calculate_marker_position:n { 10 }
        \dim_use:N \l_spellcard_marker_position_dim{}
        ~(wraps~to~0,~expected:~same~as~level~0)

  \item Level~15:
        \spellcard_calculate_marker_position:n { 15 }
        \dim_use:N \l_spellcard_marker_position_dim{}
        ~(wraps~to~5,~expected:~same~as~level~5)
\end{itemize}

\subsubsection*{Label Position Calculations}

Testing~\texttt{\token_to_str:N\spellcard_calculate_label_position:n}~for~deck~numbers:

Note:~Deck~0~has~no~label~(skipped~in~actual~use).~Printer~margins~are~set~to~7mm.

\begin{itemize}
  \item Deck~1:
        \spellcard_calculate_label_position:n { 1 }
        \dim_use:N \l_spellcard_label_position_dim{}
        ~(expected:~7mm~with~printer~margins)

  \item Deck~2:
        \spellcard_calculate_label_position:n { 2 }
        \dim_use:N \l_spellcard_label_position_dim{}

  \item Deck~3:
        \spellcard_calculate_label_position:n { 3 }
        \dim_use:N \l_spellcard_label_position_dim{}

  \item Deck~6:
        \spellcard_calculate_label_position:n { 6 }
        \dim_use:N \l_spellcard_label_position_dim{}

  \item Deck~7:
        \spellcard_calculate_label_position:n { 7 }
        \dim_use:N \l_spellcard_label_position_dim{}
        ~(wraps~to~position~1)
\end{itemize}

\subsubsection*{Marker X-Shift and Guide Width}

Testing~helper~functions~for~marker~rendering:

\begin{itemize}
  \item Marker~x-shift~(with~printer~margins): \spellcard_get_marker_xshift:
  \item Marker~guide~width~(with~printer~margins): \spellcard_get_marker_guide_width:
\end{itemize}

Now~testing~without~printer~margins~(temporarily~disable):

\bool_set_false:N \l_spellcard_has_printer_margin_bool

\begin{itemize}
  \item Marker~x-shift~(without~printer~margins): \spellcard_get_marker_xshift:
  \item Marker~guide~width~(without~printer~margins): \spellcard_get_marker_guide_width:
  \item Label~position~deck~1~(no~margins):
        \spellcard_calculate_label_position:n { 1 }
        \dim_use:N \l_spellcard_label_position_dim{}
        ~(expected:~15mm~without~margins)
\end{itemize}

% Restore printer margin flag for remaining tests
\bool_set_true:N \l_spellcard_has_printer_margin_bool

\ExplSyntaxOff

\subsection*{Phase 2.3: Conditional Logic Tests}

Testing the spell attribute functions that replace \texttt{\textbackslash{}ifthenelse} conditionals.

\subsubsection*{Test: Spell Attribute with NULL checking}

Using~\texttt{\textbackslash{}spellattribute\{label\}\{value\}}:

\begin{tabular}{rl}
  \toprule
  \spellattribute{Range}{25 ft + 5 ft/2 levels}
  \spellattribute{Components}{V, S, M}
  \spellattribute{Descriptor}{NULL}
  \spellattribute{Duration}{Instantaneous}
  \spellattribute{Area}{NULL}
  \spellattribute{Effect}{Ray}
  \spellattributelast{Saving Throw}{None}
\end{tabular}

Expected~behavior:~``Descriptor''~and~``Area''~lines~should~be~omitted~because~their~values~are~NULL.

\subsubsection*{Test: All NULL attributes}

\begin{tabular}{rl}
  \toprule
  \spellattribute{First}{NULL}
  \spellattribute{Second}{NULL}
  \spellattribute{Third}{NULL}
  \spellattributelast{Last}{Always shows}
\end{tabular}

Expected~behavior:~Only~``Last''~line~should~appear~(plus~table~rules).

\subsubsection*{Test: Mixed NULL and valid values}

\begin{tabular}{rl}
  \toprule
  \spellattribute{Name}{Magic Missile}
  \spellattribute{School}{Evocation}
  \spellattribute{Subschool}{NULL}
  \spellattribute{Descriptor}{[Force]}
  \spellattribute{Level}{1}
  \spellattribute{Unknown Field}{NULL}
  \spellattributelast{Casting Time}{1 standard action}
\end{tabular}

Expected~behavior:~``Subschool''~and~``Unknown~Field''~should~be~omitted.

\subsection*{Phase 2 Completion Summary}

All Phase 2 functions tested:

\begin{itemize}
  \item [OK] Deck management (Phase 2.1)
  \item [OK] Positioning calculations (Phase 2.2)
  \item [OK] Conditional logic (Phase 2.3)
  \item [OK] Print control (Phase 2.4)
\end{itemize}

If this document compiles without errors and produces expected output,
Phase 2 of the expl3 modernization is complete.

\newpage

\subsection*{Phase 3.1: Deck Tracking and Spell Registration Tests}

Testing the deck tracking system added in Phase 3.1 for future index card generation.

\subsubsection*{Test: Basic Deck Tracking}

Creating three NEW decks and manually registering spells (continuing from Phase 2 tests):

\begin{spelldeck}{Test Deck A}
  Test deck for Phase 3.1 (Deck 3) \\
  \ExplSyntaxOn
  \spellcard_register_spell:nnnn {spells/sor/0/AcidSplash.tex} {sor} {Acid~Splash} {0}
  \spellcard_register_spell:nnnn {spells/sor/0/DancingLights.tex} {sor} {Dancing~Lights} {0}
  \spellcard_register_spell:nnnn {spells/sor/1/MagicMissile.tex} {sor} {Magic~Missile} {1}
  \ExplSyntaxOff
\end{spelldeck}

After deck 3: Total decks = \deckcount, Deck 3 spell count = \deckspellcount{3}

\begin{spelldeck}{Test Deck B}
  Test deck for Phase 3.1 (Deck 4) \\
  \ExplSyntaxOn
  \spellcard_register_spell:nnnn {spells/sor/1/MagicMissile.tex} {sor} {Magic~Missile} {1}
  \spellcard_register_spell:nnnn {spells/sor/3/Fireball.tex} {sor} {Fireball} {3}
  \spellcard_register_spell:nnnn {spells/sor/5/Teleport.tex} {sor} {Teleport} {5}
  \ExplSyntaxOff
\end{spelldeck}

After deck 4: Total decks = \deckcount, Deck 4 spell count = \deckspellcount{4}

\begin{spelldeck}{Test Deck C}
  Test deck for Phase 3.1 (Deck 5) \\
  \ExplSyntaxOn
  \spellcard_register_spell:nnnn {spells/sor/0/DetectMagic.tex} {sor} {Detect~Magic} {0}
  \spellcard_register_spell:nnnn {spells/sor/2/Invisibility.tex} {sor} {Invisibility} {2}
  \ExplSyntaxOff
\end{spelldeck}

After deck 5: Total decks = \deckcount, Deck 5 spell count = \deckspellcount{5}

\subsubsection*{Test: Deck Query Functions}

\ExplSyntaxOn

Testing~deck~existence~checks:
\begin{itemize}
  \item Deck~0~exists: \spellcard_if_deck_exists:nTF { 0 } { YES } { NO }
  \item Deck~3~exists: \spellcard_if_deck_exists:nTF { 3 } { YES } { NO }
  \item Deck~99~exists: \spellcard_if_deck_exists:nTF { 99 } { YES } { NO }~(should~be~NO)
\end{itemize}

Spell~counts~per~deck:
\begin{itemize}
  \item Deck~0:~\spellcard_get_deck_spell_count:n { 0 }~spells~(from~Phase~2~tests)
  \item Deck~3:~\spellcard_get_deck_spell_count:n { 3 }~spells
  \item Deck~4:~\spellcard_get_deck_spell_count:n { 4 }~spells
  \item Deck~5:~\spellcard_get_deck_spell_count:n { 5 }~spells
\end{itemize}

\ExplSyntaxOff

\subsubsection*{Summary: Phase 3.1 Deck Tracking}

The deck tracking system enables:
\begin{itemize}
  \item Tracking which spells belong to each deck
  \item Counting spells per deck
  \item Querying deck existence
  \item Foundation for future index card generation
\end{itemize}

Future features (not yet implemented):
\begin{itemize}
  \item Automatic spell metadata extraction from file paths
  \item Filtering spells by level or school
  \item Sorting spell lists
  \item Exporting deck contents for index generation
\end{itemize}

\subsection*{Conclusion: Phases 1-3.1 Complete}

If this document compiles successfully:
\begin{itemize}
  \item [OK] Phase 1: Foundation complete
  \item [OK] Phase 2: Core logic migration complete
  \item [OK] Phase 3.1: Deck tracking infrastructure complete
\end{itemize}

\end{document}
