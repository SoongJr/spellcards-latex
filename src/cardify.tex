% this takes each page of the document, sizes it down to DIN A6 and places it on a DIN A4 page
% in a way that they can be cut and folded over in a way that it all ends up sorted correctly.
% lots of rotation and reordering magic going on.
%\url{https://tex.stackexchange.com/q/638802/86}
%Adapted from \url{http://tex.stackexchange.com/q/279042/86}
\usepackage{pgfmorepages}

\pgfpagesdeclarelayout{8 on 2, card format}
{%
  \edef\pgfpageoptionheight{\the\paperheight}
  \edef\pgfpageoptionwidth{\the\paperwidth}
  \edef\pgfpageoptionborder{0pt}
  \edef\pgfpageoptionfirstshipout{3}
}%
{%
  \pgfpagesphysicalpageoptions%
  {%
    logical pages=10,%
    physical pages=2,%
    physical height=\pgfpageoptionheight,%
    physical width=\pgfpageoptionwidth,%
    current logical shipout=\pgfpageoptionfirstshipout,%
    first logical shipout=\pgfpageoptionfirstshipout,%
  }
  \pgfpagesphysicalpage{1}{}
  \pgfpageslogicalpageoptions{1}
  {% page with the front sides of four cards
    resized width=\pgfphysicalwidth,%
    resized height=\pgfphysicalheight,%
    center=\pgfpoint{.5\pgfphysicalwidth}{.5\pgfphysicalheight},%
    border code={%
        \pgfusepath{discard}%
        % we draw the cutting guides here because they must match up
        % with the spell-level indicator at the side of the card!
        \color{gray!50}\pgfsetlinewidth{0.25pt}% faint gray line
        \pgfsetdash{{10pt}{5pt}}{0pt}% long dashes
        % horizontal line
        \pgfpathmoveto{\pgfpoint{-6.5pt}{.5\ht0}}%
        \pgfpathlineto{\pgfpoint{\wd0}{.5\ht0}}%
        % vertical line
        \pgfpathmoveto{\pgfpoint{.5\wd0}{-2.5pt}}%
        \pgfpathlineto{\pgfpoint{.5\wd0}{\ht0}}%
        \pgfusepath{stroke}%
        \color{black}%
        \pgfsetdash{}{0pt}%
      },%
    copy from=1,%
  }%
  \pgfpagesphysicalpage{2}{}
  \pgfpageslogicalpageoptions{2}
  {% page with the back sides of four cards
    resized width=\pgfphysicalwidth,%
    resized height=\pgfphysicalheight,%
    center=\pgfpoint{.5\pgfphysicalwidth}{.5\pgfphysicalheight},%
    % not drawing any cutting-guides on the back-side page
    % because there is no way any lines would line up with the front page.
    copy from=2,%
  }%
  \pgfpagesphysicalpage{1}{}
  \pgfpageslogicalpageoptions{3}
  {%
    rotation=0,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{5}
  {%
    rotation=180,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{7}
  {%
    rotation=0,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
  \pgfpageslogicalpageoptions{9}
  {%
    rotation=180,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
  \pgfpagesphysicalpage{2}{}
  \pgfpageslogicalpageoptions{6}
  {%
    rotation=180,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{4}
  {%
    rotation=0,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{10}
  {%
    rotation=180,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
  \pgfpageslogicalpageoptions{8}
  {%
    rotation=0,%
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
}

\AtBeginDocument{
  \pgfpagesuselayout{8 on 2, card format} % use the layout we set up above
}

% when being cardified, ensure a new card's front face does not start on the backside of the previous card:
\renewcommand{\clearcard}{\cleardoublepage}
