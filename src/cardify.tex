% this takes each page of the document, sizes it down to DIN A6 and places it on a DIN A4 page
% in a way that they can be cut and folded over in a way that it all ends up sorted correctly.
% lots of rotation and reordering magic going on.
%\url{https://tex.stackexchange.com/q/638802/86}
%Adapted from \url{http://tex.stackexchange.com/q/279042/86}
\usepackage{pgfmorepages}
\usepackage{atbegshi}           % for using \AtBeginShipout, required to draw lines over all pages

\pgfpagesdeclarelayout{8 on 2, book format}
{%
  \edef\pgfpageoptionheight{\the\paperheight}
  \edef\pgfpageoptionwidth{\the\paperwidth}
  \def\pgfpageoptionborder{0pt}
  \def\pgfpageoptionfirstshipout{1}
}%
{%
  \pgfpagesphysicalpageoptions%
  {%
    logical pages=8,%
    physical pages=2,%
    physical height=\pgfpageoptionheight,%
    physical width=\pgfpageoptionwidth,%
    current logical shipout=\pgfpageoptionfirstshipout%
  }
  \pgfpagesphysicalpage{1}{}
  \pgfpageslogicalpageoptions{1}
  {%
    rotation=0,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{3}
  {%
    rotation=180,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{5}
  {%
    rotation=0,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
  \pgfpageslogicalpageoptions{7}
  {%
    rotation=180,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
  \pgfpagesphysicalpage{2}{}
  \pgfpageslogicalpageoptions{4}
  {%
    rotation=180,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{2}
  {%
    rotation=0,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.75\pgfphysicalheight}%
  }%
  \pgfpageslogicalpageoptions{8}
  {%
    rotation=180,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.25\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
  \pgfpageslogicalpageoptions{6}
  {%
    rotation=0,
    border shrink=\pgfpageoptionborder,%
    resized width=.5\pgfphysicalwidth,%
    resized height=.5\pgfphysicalheight,%
    center=\pgfpoint{.75\pgfphysicalwidth}{.25\pgfphysicalheight},%
  }%
}

\AtBeginDocument{
  \pgfpagesuselayout{8 on 2, book format} % use the layout we set up above
}

\AtBeginShipout{
  \AtBeginShipoutUpperLeft{
    % % draw cut lines to show where to cut the paper
    % DISABLED: consumer-level printers are not exact enough to cut on these lines (mine was off by 2mm),
    %           so the front and back sides of cards would not line up!
    % Instead, user should either fold a sacrificial paper in half to use a guide, or use a paper cutter (copyshop? at work?)
    % \begin{tikzpicture}[remember picture, overlay]
    %   \draw[lightgray, dashed] (current page.north east) -- (current page.south east) -- (current page.south west);
    % \end{tikzpicture}
  }
}

% when being cardified, ensure a new card's front face does not start on the backside of the previous card:
\renewcommand{\clearcard}{\cleardoublepage}
