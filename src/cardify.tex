% this takes each page of the document, sizes it down to DIN A6 and places it on a DIN A4 page
% in a way that they can be cut and folded over in a way that it all ends up sorted correctly.
% lots of rotation and reordering magic going on.
%\url{https://tex.stackexchange.com/q/638802/86}
%Adapted from \url{http://tex.stackexchange.com/q/279042/86}
\usepackage{pgfmorepages}

\pgfpagesdeclarelayout{8 on 2, card format}
{%
  \edef\pgfpageoptionheight{\the\paperheight}
  \edef\pgfpageoptionwidth{\the\paperwidth}
  \edef\pgfpageoptionborder{0pt}
  \edef\pgfpageoptionfirstshipout{3}
  % calculate proper sizes and offsets for positioning the cards:
  \newlength{\printermarginx}\pgfmathsetlength{\printermarginx}{+4.75mm}% adjust this to your printer's unprintable margin
  \newlength{\printermarginy}\pgfmathsetlength{\printermarginy}{\printermarginx*1.41421356}% must maintain aspect page's ratio
  \newlength{\resizedwidth}\pgfmathsetlength{\resizedwidth}{.5*\pgfphysicalwidth-\printermarginx}%
  \newlength{\resizedheight}\pgfmathsetlength{\resizedheight}{.5*\pgfphysicalheight-\printermarginy}%
}%
{%
  \pgfpagesphysicalpageoptions%
  {%
    logical pages=10,%
    physical pages=2,%
    physical height=\pgfpageoptionheight,%
    physical width=\pgfpageoptionwidth,%
    current logical shipout=\pgfpageoptionfirstshipout,%
    first logical shipout=\pgfpageoptionfirstshipout,%
  }
  \pgfpagesphysicalpage{1}{}
  \pgfpageslogicalpageoptions{1}
  {% page with the front sides of four cards
    resized width=\pgfphysicalwidth,%
    resized height=\pgfphysicalheight,%
    center=\pgfpoint{.5\pgfphysicalwidth}{.5\pgfphysicalheight},%
    border code={%
        \pgfusepath{discard}%
        % we draw the cutting guides here because they must match up
        % with the spell-level indicator at the side of the card!
        \color{gray!50}\pgfsetlinewidth{0.25pt}% faint gray line
        \pgfsetdash{{10pt}{5pt}}{0pt}% long dashes
        % horizontal line
        \pgfpathmoveto{\pgfpoint{-6.5pt}{.5\ht0}}%
        \pgfpathlineto{\pgfpoint{\wd0}{.5\ht0}}%
        % vertical line
        \pgfpathmoveto{\pgfpoint{.5\wd0}{-2.5pt}}%
        \pgfpathlineto{\pgfpoint{.5\wd0}{\ht0}}%
        %
        \pgfusepath{stroke}%
        \color{black}%
        \pgfsetdash{}{0pt}%
      },%
    copy from=1,%
  }%
  \pgfpagesphysicalpage{2}{}
  \pgfpageslogicalpageoptions{2}
  {% page with the back sides of four cards
    resized width=\pgfphysicalwidth,%
    resized height=\pgfphysicalheight,%
    center=\pgfpoint{.5\pgfphysicalwidth}{.5\pgfphysicalheight},%
    % not drawing any cutting-guides on the back-side page
    % because there is no way any lines would line up with the front page.
    copy from=2,%
  }%
  %
  \pgfpagesphysicalpage{1}{}
  \pgfpageslogicalpageoptions{3}
  {%
    rotation=0,%
    % each printer has its own individual margins they can print to,
    % shrinking this page by a printer-dependant value and shifting it
    % to align with the page's centerlines:
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.25\pgfphysicalwidth+.5\printermarginx}{.75\pgfphysicalheight-.5\printermarginy},%
    % draw cutting guides opposite the central lines to accomodate printer tolerances,
    % the user will have to trim the external margins of the cards at these lines.
    border code={%
        \pgfusepath{discard}%
        \color{gray!50}\pgfsetlinewidth{.75pt}% gray line
        \pgfsetdash{{20pt}{10pt}}{0pt}% long dashes
        \pgfpathmoveto{\pgfpoint{0pt}{0pt}}%
        \pgfpathlineto{\pgfpoint{0pt}{\ht0}}%
        \pgfpathlineto{\pgfpoint{\wd0}{\ht0}}%
        \pgfusepath{stroke}%
        \color{black}%
        \pgfsetdash{}{0pt}%
      },%
  }%
  \pgfpageslogicalpageoptions{5}
  {%
    rotation=180,%
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.75\pgfphysicalwidth-.5\printermarginx}{.75\pgfphysicalheight-.5\printermarginy},%
    border code={%
        \pgfusepath{discard}%
        \color{gray!50}\pgfsetlinewidth{.75pt}% gray line
        \pgfsetdash{{20pt}{10pt}}{0pt}% long dashes
        \pgfpathmoveto{\pgfpoint{\wd0}{0pt}}%
        \pgfpathlineto{\pgfpoint{0pt}{0pt}}%
        \pgfpathlineto{\pgfpoint{0pt}{\ht0}}%
        \pgfusepath{stroke}%
        \color{black}%
        \pgfsetdash{}{0pt}%
      },%
  }%
  \pgfpageslogicalpageoptions{7}
  {%
    rotation=0,%
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.25\pgfphysicalwidth+.5\printermarginx}{.25\pgfphysicalheight+.5\printermarginy},%
    border code={%
        \pgfusepath{discard}%
        \color{gray!50}\pgfsetlinewidth{.75pt}% gray line
        \pgfsetdash{{20pt}{10pt}}{0pt}% long dashes
        \pgfpathmoveto{\pgfpoint{\wd0}{0pt}}%
        \pgfpathlineto{\pgfpoint{0pt}{0pt}}%
        \pgfpathlineto{\pgfpoint{0pt}{\ht0}}%
        \pgfusepath{stroke}%
        \color{black}%
        \pgfsetdash{}{0pt}%
      },%
  }%
  \pgfpageslogicalpageoptions{9}
  {%
    rotation=180,%
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.75\pgfphysicalwidth-.5\printermarginx}{.25\pgfphysicalheight+.5\printermarginy},%
    border code={%
        \pgfusepath{discard}%
        \color{gray!50}\pgfsetlinewidth{.75pt}% gray line
        \pgfsetdash{{20pt}{10pt}}{0pt}% long dashes
        \pgfpathmoveto{\pgfpoint{0pt}{0pt}}%
        \pgfpathlineto{\pgfpoint{0pt}{\ht0}}%
        \pgfpathlineto{\pgfpoint{\wd0}{\ht0}}%
        \pgfusepath{stroke}%
        \color{black}%
        \pgfsetdash{}{0pt}%
      },%
  }%
  %
  \pgfpagesphysicalpage{2}{}
  \pgfpageslogicalpageoptions{6}
  {%
    rotation=180,%
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.25\pgfphysicalwidth+.5\printermarginx}{.75\pgfphysicalheight-.5\printermarginy},%
    % back side gets no cutting guides as they would not line up with the front!
    border shrink=\pgfpageoptionborder,%
  }%
  \pgfpageslogicalpageoptions{4}
  {%
    rotation=0,%
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.75\pgfphysicalwidth-.5\printermarginx}{.75\pgfphysicalheight-.5\printermarginy},%
    border shrink=\pgfpageoptionborder,%
  }%
  \pgfpageslogicalpageoptions{10}
  {%
    rotation=180,%
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.25\pgfphysicalwidth+.5\printermarginx}{.25\pgfphysicalheight+.5\printermarginy},%
    border shrink=\pgfpageoptionborder,%
  }%
  \pgfpageslogicalpageoptions{8}
  {%
    rotation=0,%
    resized width=\resizedwidth,%
    resized height=\resizedheight,%
    center=\pgfpoint{.75\pgfphysicalwidth-.5\printermarginx}{.25\pgfphysicalheight+.5\printermarginy},%
    border shrink=\pgfpageoptionborder,%
  }%
}

\AtBeginDocument{
  \pgfpagesuselayout{8 on 2, card format} % use the layout we set up above
}

% when being cardified, ensure a new card's front face does not start on the backside of the previous card:
\renewcommand{\clearcard}{\cleardoublepage}
