% Compatibility wrapper for spell card templates when using spellcard-expl3 package
% This file provides commands that spell files expect but that aren't yet
% in the expl3 package (like \spellcardinfo).
%
% Only define things that expl3 doesn't provide yet.

% Helper commands
\newcommand{\FIXME}[1]{}% Does nothing, just flags for chktex warning

% NOTE: \ifprintcard, \currentdeckname, and \currentdecknumber are now
% provided by spellcard-expl3.sty as compatibility exports

% Legacy noprint command (expl3 has \includespell[noprint])
\providecommand{\noprint}[1]{\printcardfalse\input{#1}\printcardtrue}% chktex 27

% Provide \clearcard command,
\providecommand{\clearcard}{\clearpage}
% cardify.tex overrides this to cleardoublepage so each card will have a backside.

% Spell attribute rendering with NULL filtering
% Note: Cannot be used as the bottom-most line of a table (use \spellattributelast for that)
\providecommand{\spellattribute}[2]{%
  \ifthenelse{\equal{#2}{NULL}}{}{\textbf{#1:} & #2 \\ \midrule}%
}
\providecommand{\spellattributelast}[2]{\textbf{#1:} & #2 \\ \bottomrule}

% Function for drawing the deck label at the top edge of the card
% Horizontal positioning based on deck number
\providecommand{\drawdecklabel}[2]{%
  % #1 = deck index, #2 = deck name
  % deck #0 is the full spell book and has no label.
  \ifthenelse{\equal{#1}{0}}{}{%
    \begin{tikzpicture}[remember picture, overlay]%
      % Calculate horizontal position based on deck number
      % Position from left edge, with spacing for multiple decks
      \pgfmathparse{mod(#1-1,6)}% support up to 6 decks before wrapping
      \ifdefined\printermarginx%
        \pgfmathsetmacro{\labelposition}{\fpeval{((1/8 * \pgfmathresult)) * \paperwidth} + 7mm}%
      \else%
        \pgfmathsetmacro{\labelposition}{\fpeval{((1/8 * \pgfmathresult)) * \paperwidth} + 15mm}%
      \fi%
      % Print the deck name at the top edge, horizontally
      % Use \printermarginy if available (from cardify.tex), otherwise use fixed offset
      \ifdefined\printermarginy%
        \node [font=\normalsize\itshape, anchor=west, xshift=\labelposition, yshift=-7mm] at (current page.north west){#2};%
      \else%
        \node [font=\normalsize\itshape, anchor=west, xshift=\labelposition, yshift=-15mm] at (current page.north west){#2};%
      \fi%
    \end{tikzpicture}%
  }%
}

% Function for drawing the spell marker (copied from legacy spellcard-templates.tex)
\providecommand{\drawspellmarker}[1]{%
  \begin{tikzpicture}[remember picture, overlay]%
    % based on \spelllevel (argument 1), determine the height the marker should appear at.
    \pgfmathparse{mod(#1,10)}% there are 9 levels in core books, but other books may have higher spells. Make sure they do not overshoot the page.
    \pgfmathsetmacro{\markerposition}{\fpeval{((1/16 * \pgfmathresult)) * \paperheight} + 2.5cm}% defines where the first marker shows up (center-point), and the spacing between them
    % print the spelllevel at the edge of the page, \markerposition from the top,
    % and draw light-gray lines above and below it as guides for the user to apply highlighting (my highlighter's width is 4mm...)
    \ifdefined\printermarginx%
      \node [font=\Large, anchor=center, xshift=-7mm,yshift=-\markerposition] at (current page.north east){\textbf{#1}};%
      \draw[lightgray, dotted, line width=1pt] (current page.north east) ++(0cm,-\markerposition+8mm) -- ++(-14mm,0) -- ++(0,-16mm) -- ++(14mm,0);%
    \else%
      \node [font=\Large, anchor=center, xshift=-7mm-5mm,yshift=-\markerposition] at (current page.north east){\textbf{#1}};%
      \draw[lightgray, dotted, line width=1pt] (current page.north east) ++(0cm,-\markerposition+8mm) -- ++(-14mm-5mm,0) -- ++(0,-16mm) -- ++(14mm+5mm,0);%
    \fi%
  \end{tikzpicture}%
}

% Spell card environment (expl3 doesn't provide this yet - it expects templates to)
% This is a minimal version that works with expl3's deck tracking
% NOTE: Does NOT use grouping - spell commands persist across cards to allow reuse
\ifx\spellcard\undefined
  \newenvironment{spellcard}[3]{%
    % Make \newcommand work like \def (unconditionally define, overwriting if needed)
    % This is needed because spell files use \newcommand for all attributes,
    % and we need each spell to overwrite the previous spell's values
    \let\oldnewcommand\newcommand%
    \renewcommand{\newcommand}[2]{%
      \ifcsname ##1\endcsname%
        \expandafter\def\csname ##1\endcsname{##2}%
      \else%
        \oldnewcommand{##1}{##2}%
      \fi%
    }%
    % Now render title using environment parameters (in a group so they don't persist)
    \begingroup{}%
    \def\class{#1}%
    \def\name{#2}%
    \def\spelllevel{#3}%
    \ifprintcard%
      \section*{\Huge\name\hfill\MakeUppercase{\class}~\spelllevel}%
      \drawdecklabel{\value{currentdecknumber}}{\currentdeckname}%
      \drawspellmarker{\spelllevel}%
    \fi%
    \endgroup{}%
  }{%
    \ifprintcard%
      \clearcard%
    \fi%
    \setcounter{page}{1}%
    \setcounter{table}{0}%
    \setcounter{figure}{0}%
    % Reset QR code counter (must use wrapper to sync both LaTeX2e and expl3 counters)
    \resetqrcounter%
  }%
\fi

% Tabular information for spell
\providecommand{\spellcardinfo}[1][0.5]{%
  \normalsize%
  \def\firsttablewidth{#1}%
  \def\secondtablewidth{\fpeval{1-#1}}%
  \noindent%
  \begin{tabularx}{\firsttablewidth\textwidth}[b]{r>{\raggedright\arraybackslash}X}%
    \toprule%
    \spellattribute{Casting Time}{\castingtime}%
    \spellattribute{Saving Throw}{\savingthrow}%
    \spellattribute{Spell Resist}{\spellresistance}%
    \spellattributelast{Attack Roll}{\attackroll}%
  \end{tabularx}%
  \hfill%
  \begin{tabularx}{\secondtablewidth\textwidth-\tabcolsep}[b]{r>{\raggedright\arraybackslash}X}%
    \toprule%
    \spellattribute{Duration}{\duration}%
    \spellattribute{Area}{\area}%
    \spellattribute{Range}{\range}%
    \spellattribute{Comp.}{\components}%
    \ifthenelse{\equal{\school}{evocation} \AND\NOT\equal{\descriptor}{NULL}}%
    {\textbf{School:} & \school{} (\descriptor{})} %
    {\textbf{School:} & \school{}                } \\ \bottomrule%
  \end{tabularx}%
  \ifthenelse{\equal{\targets}{NULL}\AND\equal{\effect}{NULL}}{% omit the table if nothing to display
  }{\\
    \begin{tabularx}{\textwidth}{r>{\raggedright\arraybackslash}X}%
      \toprule%
      \ifthenelse{\equal{\targets}{NULL}}{}{%
        \ifthenelse{\equal{\effect}{NULL}}{%
      \textbf{Target:} & \targets{} \\ \bottomrule% Last row
        }{%
      \textbf{Target:} & \targets{} \\ \midrule% More rows follow
        }%
      }%
      \ifthenelse{\equal{\effect}{NULL}}{}{%
      \textbf{Effect:} & \effect{}  \\ \bottomrule% Last row (or only row)
      }%
    \end{tabularx}%
  }%
  \vspace{1ex} \\
  \raggedright\Large%
}
