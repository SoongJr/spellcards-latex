% this file contains templates to show spell cards.
% They are be used by convert.sh to create spell cards from the Spell-DB,
% but the user is encouraged to modify those files to best suit their needs
% (fit spells on the cards nicely, rephrase ambigious descriptions,
% include information from other spells for those "works like X" spells, etc.)
%
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Helper commands
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Empty command for marking properties that need manual attention
% (spell card generator adds these markers for inconclusive auto-detection)
\newcommand{\FIXME}[1]{}% Does nothing, just flags for chktex warning
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Deck management commands
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\currentdeckname}{} % current deck name
% Counter for tracking which deck we're in (for horizontal positioning)
\newcounter{currentdecknumber}\setcounter{currentdecknumber}{0}%
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Environment for defining a spell deck
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Usage: Mandatory "spellbook" deck with no name first, then optional named decks
% \begin{spelldeck}{}
% \end{spelldeck}
% \begin{spelldeck}{deckname}
%   \noprint{spells/sor/0/Acid Splash}
%   \input{spells/sor/1/Magic Missile}
% \end{spelldeck}
\newenvironment{spelldeck}[1]{% Start new deck
  % these environments are not intended to be nested, issue an error if that happens:
  % currentdeckname already being defined means we are already in a deck
  \ifthenelse{\equal{\currentdeckname}{}}{}{\PackageError{spellcard-templates}%
    {Nested spell decks are not supported. Possibly forgot to end a spelldeck}{}}%
  \renewcommand{\currentdeckname}{#1}% must be empty for currentdecknumber==0
  \ifthenelse{\equal{\value{currentdecknumber}}{0}}{%
    \ifthenelse{\equal{\currentdeckname}{}}{}{%
      % throw an error during generation to tell user the first deck must be unnamed
      \PackageError{spellcard-templates}{First deck must be unnamed}{}%
    }%
  }{%
    \ifthenelse{\equal{\currentdeckname}{}}{%
      % throw an error during generation to tell user the first deck must be unnamed
      \PackageError{spellcard-templates}{Only the first deck may be unnamed}{}%
    }{}%
  }%
}{% End of deck
  \stepcounter{currentdecknumber}%
  \gdef\currentdeckname{}% Clear deck name so it's not used inadvertantly
}
%
\newif\ifprintcard\printcardtrue% check whether a spell card shall be printed
% Drop-in replacement for "\input" to include a spell without printing it:
% This is for spells that have been printed before and don't need reprinting.
% chktex cannot parse dnymic inputs, so we disable it, assuming any warnings
% have already been addressed when the card was previously printed.
\newcommand{\noprint}[1]{\printcardfalse\input{#1}\printcardtrue}% chktex 27
%
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Function for drawing the deck label at the top edge of the card
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Horizontal positioning based on deck number
\newcommand{\drawdecklabel}[2]{%
  % #1 = deck index, #2 = deck name
  % deck #0 is the full spell book and has no label.
  \ifthenelse{\equal{#1}{0}}{}{%
    \begin{tikzpicture}[remember picture, overlay]%
      % Calculate horizontal position based on deck number
      % Position from left edge, with spacing for multiple decks
      \pgfmathparse{mod(#1-1,6)}% support up to 6 decks before wrapping
      \ifdefined\printermarginx%
        \pgfmathsetmacro{\labelposition}{\fpeval{((1/8 * \pgfmathresult)) * \paperwidth} + 7mm}%
      \else%
        \pgfmathsetmacro{\labelposition}{\fpeval{((1/8 * \pgfmathresult)) * \paperwidth} + 15mm}%
      \fi%
      % Print the deck name at the top edge, horizontally
      % Use \printermarginy if available (from cardify.tex), otherwise use fixed offset
      \ifdefined\printermarginy%
        \node [font=\normalsize\itshape, anchor=west, xshift=\labelposition, yshift=-7mm] at (current page.north west){#2};%
      \else%
        \node [font=\normalsize\itshape, anchor=west, xshift=\labelposition, yshift=-15mm] at (current page.north west){#2};%
      \fi%
    \end{tikzpicture}%
  }%
}
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% function for drawing the spell marker
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% draw a marker on the right side of the page to quickly flip through the cards
% and find the spell level you are looking for.
% When cardified, this edge will be at the center of a DIN A4 page,
% so there is no problem printing "all the way to the edge".
% The intention is for the user to color the marker with a highlighter after cutting the pages free.
\newcommand{\drawspellmarker}[1]{%
  \begin{tikzpicture}[remember picture, overlay]%
    % based on \spelllevel (argument 1), determine the height the marker should appear at.
    \pgfmathparse{mod(#1,10)}% there are 9 levels in core books, but other books may have higher spells. Make sure they do not overshoot the page.
    \pgfmathsetmacro{\markerposition}{\fpeval{((1/16 * \pgfmathresult)) * \paperheight} + 2.5cm}% defines where the first marker shows up (center-point), and the spacing between them
    % print the spelllevel at the edge of the page, \markerposition from the top,
    % and draw light-gray lines above and below it as guides for the user to apply highlighting (my highlighter's width is 4mm...)
    \ifdefined\printermarginx%
      \node [font=\Large, anchor=center, xshift=-7mm,yshift=-\markerposition] at (current page.north east){\textbf{#1}};%
      \draw[lightgray, dotted, line width=1pt] (current page.north east) ++(0cm,-\markerposition+8mm) -- ++(-14mm,0) -- ++(0,-16mm) -- ++(14mm,0);%
    \else%
      \node [font=\Large, anchor=center, xshift=-7mm-5mm,yshift=-\markerposition] at (current page.north east){\textbf{#1}};%
      \draw[lightgray, dotted, line width=1pt] (current page.north east) ++(0cm,-\markerposition+8mm) -- ++(-14mm-5mm,0) -- ++(0,-16mm) -- ++(14mm+5mm,0);%
    \fi%
  \end{tikzpicture}%
}%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% environment for formatting a spell card (title-bar, header/footer, etc.)
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{spellcard}[3]{%
  \begingroup{}%        make macro declarations only affect the content of the "begin" statement
  \def\class{#1}%       character class (wiz, sor, etc.)
  \def\name{#2}%        spell name
  \def\spelllevel{#3}%  spell level for this character class
  \ifprintcard% Only print the card if the printcard flag is true
    % Titlebar for spell (spell name and level):
    \section*{\Huge\name\hfill\MakeUppercase{\class}~\spelllevel}%
    % Deck name is shown at the top edge:
    \drawdecklabel{\value{currentdecknumber}}{\currentdeckname}%
    % spell-level markers are drawn along the right-hand edge:
    \drawspellmarker{\spelllevel}%
  \fi%
  \endgroup{}%
  % skip the body of this environment if we are not printing the card
  \ifprintcard%
  \fi%
}{%
  \ifprintcard%
    \clearcard% start next spell on a fresh page (ensuring its front face is not printed on the back of the previous card)
  \fi%
  % reset counters after each spell so cards are independent of each other:
  \setcounter{page}{1}%
  \setcounter{table}{0}%
  \setcounter{figure}{0}%
  \setcounter{qrCode}{0}%
}%

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Tabular information for spell
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% command to print one attribute of the spell in the spell card table that can be NULL (shall be omitted if that's the case)
% Note: These cannot be used as the bottom-most line of the table, as they would not print a line after them.
\newcommand{\spellattribute}[2]{%
  \ifthenelse{\equal{#2}{NULL}}{}{\textbf{#1:} & #2 \\ \midrule}%
}%
% this command is for the last line of each table and cannot be NULL
\newcommand{\spellattributelast}[2]{\textbf{#1:} & #2 \\ \bottomrule}%
%
% Note that TSV headers contain underscores, but LaTeX macros can only contain letters,
% so columns such as "spell_level" should be referred to as "\spelllevel{}"
\newcommand{\spellcardinfo}[1][0.5]{%
  % reduced font size for table so we can fit two next to each other on one card
  \normalsize%
  % how much width of the page is offered to the first table is adjustable with optioonal parameter, second table gets the rest:
  \def\firsttablewidth{#1}%
  \def\secondtablewidth{\fpeval{1-#1}}%
  % longer attribute names should be added to the left table, shorter ones to the right.
  % prevent indenting the tables so we have the full width of the text area available:
  \noindent%
  \begin{tabularx}{\firsttablewidth\textwidth}[b]{r>{\raggedright\arraybackslash}X}%
    \toprule%
    \spellattribute{Casting Time}{\castingtime}%
    \spellattribute{Saving Throw}{\savingthrow}%
    \spellattribute{Spell Resist}{\spellresistance}%
    \spellattributelast{Attack Roll}{\attackroll}%
  \end{tabularx}%
  \hfill%
  \begin{tabularx}{\secondtablewidth\textwidth-\tabcolsep}[b]{r>{\raggedright\arraybackslash}X}%
    \toprule%
    \spellattribute{Duration}{\duration}%
    \spellattribute{Area}{\area}%
    \spellattribute{Range}{\range}%
    \spellattribute{Comp.}{\components}%
    % evocation school is special as we want to include its descriptor:
    \ifthenelse{\equal{\school}{evocation} \AND\NOT\equal{\descriptor}{NULL}}%
    {\textbf{School:} & \school{} (\descriptor{})} %
    {\textbf{School:} & \school{}                } \\ \bottomrule%
  \end{tabularx}%
  % A third table spanning the whole width for extra-long attributes:
  \ifthenelse{\equal{\targets}{NULL}\AND\equal{\effect}{NULL}}{% omit the table if nothing to display
  }{\\
    \begin{tabularx}{\textwidth}{r>{\raggedright\arraybackslash}X}%
      \spellattribute{Target}{\targets}%
      \spellattribute{Effect}{\effect}%
      % if you add more attributes here, adjust the condition above!
    \end{tabularx}%
  }%
  % insert some space before the description begins
  \vspace{1ex} \\
  % increased font size for the spell description for easier reading in low light
  \raggedright\Large%
}%
%
% provide a command to print a QR code at the bottom of the current page (front face by default, but user may move it to the back manually)
% drawing multiple QR codes requires a counter:
\newcounter{qrCode}\setcounter{qrCode}{0}%
\newcommand{\qrCodeToPrint}{} % define \qrCodeToPrint initially
\newcommand{\spellcardqr}[1]{%
  % we currently only support two qr codes per page, it gets complicated enough as it is.
  % Consider using the back face, even if it's currently empty (use an explicit \clearpage)
  \ifthenelse{\value{qrCode} > 1}{\PackageError{spellcard-templates}%
    {Too many QR codes on one page. Consider moving it to the back of the card with an explicit `clearpage`}%
    {We currently only support two QR codes per page.}%
  }{}%
  % create QR Code itself from the argument to reduce redundancy:
  \def\qrCodeToPrint{\qrcode{#1}}%
  % place the first code of each page at the bottom, opposite the page number.
  % a second code would be placed on the same side as the page number (easier to scan), with enough space to avoid overlap.
  \ifthenelse{\equal{\value{qrCode}}{0}}{%
    \def\qrCodeShift{2cm}% the first qr Code is always placed opposite the page number and needs a smaller offset from the edge of the page
  }{%
    \def\qrCodeShift{4cm}% the second one needs to leave space for the page number
  }%
  \ifodd\value{page}%
    % the page number is on the right side
    \ifthenelse{\equal{\value{qrCode}}{0}}{%
      % we want to print the first code on the left side with a smaller offset
      \begin{tikzpicture}[remember picture, overlay]%
        \node [anchor=south west, xshift=\qrCodeShift,yshift=1cm] at (current page.south west) {\qrCodeToPrint};%
      \end{tikzpicture}%
    }{%
      % we want to print the second code on the right side, next to the page number, so need a larger offset
      \begin{tikzpicture}[remember picture, overlay]%
        \node [anchor=south east, xshift=-\qrCodeShift,yshift=1cm] at (current page.south east) {\qrCodeToPrint};%
      \end{tikzpicture}%
    }%
  \else%
    % the page number is on the left side
    \ifthenelse{\equal{\value{qrCode}}{0}}{%
      % we want to print the first code on the right side with a smaller offset
      \begin{tikzpicture}[remember picture, overlay]%
        \node [anchor=south east, xshift=-\qrCodeShift,yshift=1cm] at (current page.south east) {\qrCodeToPrint};%
      \end{tikzpicture}%
    }{%
      % we want to print the second code on the left side, next to the page number, so need a larger offset
      \begin{tikzpicture}[remember picture, overlay]%
        \node [anchor=south west, xshift=\qrCodeShift,yshift=1cm] at (current page.south west) {\qrCodeToPrint};%
      \end{tikzpicture}%
    }%
  \fi%
  \stepcounter{qrCode}%
}%
%
% provide a command for printing a reference chart for spell-level markers
\newcommand{\spellmarkerchart}{%
  \section*{\Huge look-up card for spell-level marker colors}%
  \vspace{1ex}%
  \raggedright\Large%
  To the right you see the markers for all possible spell levels.\\
  These are intended to be colored with a highlighter and serve as a reference
  for which colors you decided to use when printing new cards.
  \drawspellmarker{0}\drawspellmarker{1}\drawspellmarker{2}\drawspellmarker{3}\drawspellmarker{4}%
  \drawspellmarker{5}\drawspellmarker{6}\drawspellmarker{7}\drawspellmarker{8}\drawspellmarker{9}%
  \clearcard{}%
  % reset page counter the same way the spellcards environment does:
  \setcounter{page}{1}%
}%
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The description of the spell is written in the spells' file within the spellcards environment, no need for a template here.
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%