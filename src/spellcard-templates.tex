% this file contains templates to show spell cards.
% They are be used by convert.sh to create spell cards from the Spell-DB,
% but the user is encouraged to modify those files to best suit their needs
% (fit spells on the cards nicely, rephrase ambigious descriptions,
% include information from other spells for those "works like X" spells, etc.)


% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% environment for formatting a spell card (title-bar, header/footer, etc.)
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{spellcard}[3]{%
  \begingroup{}   % make macro declarations only affect the content of the "begin" statement
  \def\class{#1}  % character class (wiz, sor, etc.)
  \def\name{#2}   % spell name
  \def\spelllevel{#3}  % spell level for this character class

  % Titlebar for spell (spell name and level)
  \section*{\Huge\name\hfill\MakeUppercase{\class}~\spelllevel}

  % draw a marker on the right side of the page to quickly flip through the cards
  % and find the spell level you are looking for
  % No ordinary printer will be capable of actually printing these to the edge,
  % but maybe we can get pretty close and dedicated users can finish it by hand,
  % possibly color-coding the spell levels for even easier identification.
  \begin{tikzpicture}[remember picture, overlay]
    % based on \spelllevel, determine the height the marker should appear at.
    \pgfmathparse{mod(\spelllevel-1,10)}% there are 9 levels in core books, but other books may have higher spells. Make sure they do not overshoot the page.
    \pgfmathsetmacro{\markerposition}{\fpeval{4/16 + (1/16 * \pgfmathresult)}}% defines where the first marker shows up (center-point), and the spacing between them
    % print the spelllevel close to the edge of the page, \markerposition from the top
    % (Note: MY printer can print up to .75 cm towards the edge of the page, you may have to fine-tune the position)
    \node [xshift=-1cm,yshift=-\markerposition\paperheight] at (current page.north east)[font=\Large]{\textbf{\spelllevel}};
    % draw light-gray lines above and below the spelllevel as guides for the user to apply highlighting (my highlighter's width is 4mm...)
    \draw[gray, dotted, line width=1pt] (current page.north east) ++(0cm,-\markerposition\paperheight+8mm) -- ++(-1.5cm,0) -- ++(0,-16mm) -- ++(1.5cm,0);
  \end{tikzpicture}
  \endgroup{}
}{%
  \clearcard% start new spell on a fresh page (ensuring its front face is not printed on the back of the previous card)
  % reset counters after each spell so cards are independent of each other:
  \setcounter{page}{1}
  \setcounter{table}{0}
  \setcounter{figure}{0}
}

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Tabular information for spell
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% command to print one attribute of the spell in the spell card table that can be NULL (shall be omitted if that's the case)
% Note: These cannot be used as the bottom-most line of the table, as they would not print a line after them.
\newcommand{\spellattribute}[2]{%
  \ifthenelse{\equal{#2}{NULL}}{}{\textbf{#1:} & #2 \\ \midrule}
}
% this command is for the last line of each table and cannot be NULL
\newcommand{\spellattributelast}[2]{\textbf{#1:} & #2 \\ \bottomrule}

% Note that TSV headers contain underscores, but LaTeX macros can only contain letters,
% so columns such as "spell_level" should be referred to as "\spelllevel{}"
\newcommand{\spellcardinfo}[1][0.5]{%
  % reduced font size for table so we can fit two next to each other on one card
  \normalsize
  % how much width of the page is offered to the first table is adjustable with optioonal parameter, second table gets the rest:
  \def\firsttablewidth{#1}
  \def\secondtablewidth{\fpeval{1-#1}}
  % longer attribute names should be added to the left table, shorter ones to the right.
  % prevent indenting the tables so we have the full width of the text area available:
  \noindent
  \begin{tabularx}{\firsttablewidth\textwidth}[b]{r>{\raggedright\arraybackslash}X}
    \toprule
    \spellattribute{Casting Time}{\castingtime}
    \spellattribute{Duration}{\duration}
    \spellattribute{Saving Throw}{\savingthrow}
    \spellattributelast{Spell Resist}{\spellresistance}
  \end{tabularx}
  \hfill
  \begin{tabularx}{\secondtablewidth\textwidth-\tabcolsep}[b]{r>{\raggedright\arraybackslash}X}
    \toprule
    \spellattribute{Area}{\area}
    \spellattribute{Range}{\range}
    \spellattribute{Comp.}{\components}
    % evocation school is special as we want to include its descriptor:
    \ifthenelse{\equal{\school}{evocation} \AND\NOT\equal{\descriptor}{NULL}}%
    {\textbf{School:} & \school{} (\descriptor{})} %
    {\textbf{School:} & \school{}                } \\ \bottomrule
  \end{tabularx}
  % A third table spanning the whole width for extra-long attributes:
  \ifthenelse{\equal{\targets}{NULL}\AND\equal{\effect}{NULL}}{}{% omit the table if nothing to display
    \begin{tabularx}{\textwidth}{r>{\raggedright\arraybackslash}X}
      \spellattribute{Target}{\targets}
      \spellattribute{Effect}{\effect}
      % if you add more attributes here, adjust the condition above!
    \end{tabularx}
  }
  % TODO: display which meta-magic feats can be applied to this spell. This information is not part of the Spell-DB, must be provided manually...
  % insert some space before the description begins
  \vspace{1ex} \\
  % increased font size for the spell description for easier reading in low light
  \raggedright\Large
}
% TODO: display a QR code to the spell's page on d20pfsrd

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The description of the spell is written in the spells' file within the spellcards environment, no need for a template here.
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
